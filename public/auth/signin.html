<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0 maximum-scale=1.0, user-scalable=no"
        />
        <title>LoadXpress | Signin</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="../css/auths.css" />
    </head>
    <body>
        <div class="page-container">
            <div class="orb orb-primary"></div>
            <div class="orb orb-secondary"></div>

            <div class="auth-wrapper">
                <div class="branding-section">
                    <div class="brand-header">
                        <img
                            src="../assets/logo.png"
                            alt="LoadXpress"
                            width="120"
                            height="60"
                        />
                    </div>

                    <div class="hero-content">
                        <h1>
                            The Future of <br /><span>Nigerian Top-ups.</span>
                        </h1>
                        <p>
                            Join 50,000+ users enjoying instant, zero-fee
                            recharges and data bundles.
                        </p>
                    </div>

                    <div class="benefit-tiles">
                        <div class="tile">
                            <div class="tile-icon">
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
                                    />
                                </svg>
                            </div>
                            <span>Secure</span>
                        </div>
                        <div class="tile">
                            <div class="tile-icon">
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path
                                        d="M13 2L3 14H12L11 22L21 10H12L13 2Z"
                                    />
                                </svg>
                            </div>
                            <span>Instant</span>
                        </div>
                        <div class="tile">
                            <div class="tile-icon">
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M16 8l-4 4-4-4" />
                                </svg>
                            </div>
                            <span>Reliable</span>
                        </div>
                    </div>

                    <div class="trust-bar">
                        <div class="avatar-group">
                            <img src="https://i.pravatar.cc/100?u=a" alt="" />
                            <img src="https://i.pravatar.cc/100?u=b" alt="" />
                            <img src="https://i.pravatar.cc/100?u=c" alt="" />
                            <div class="avatar-count">+25k</div>
                        </div>
                        <span class="trust-text"
                            >Verified users across Nigeria</span
                        >
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-inner">
                        <div class="form-title">
                            <h2>Welcome back!</h2>
                            <p>Fill in your details to continue your journey.</p>
                        </div>

                        <div class="auth-options">
                            <button
                                class="social-btn"
                                id="googleBtn"
                                type="button"
                            >
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 48 48"
                                    xmlns="http://www.w3.org/2000/svg"
                                    aria-label="Google"
                                >
                                    <path
                                        fill="#EA4335"
                                        d="M24 9.5c3.1 0 5.9 1.1 8.1 2.9l6-6C34.4 2.5 29.6 0 24 0 14.6 0 6.4 5.4 2.7 13.3l7 5.4C11.6 13.3 17.3 9.5 24 9.5z"
                                    />
                                    <path
                                        fill="#4285F4"
                                        d="M46.5 24.5c0-1.7-.1-3-.4-4.5H24v8.5h12.7c-.5 2.9-2.2 5.4-4.7 7.1l7.2 5.6c4.2-3.9 6.3-9.7 6.3-16.7z"
                                    />
                                    <path
                                        fill="#FBBC05"
                                        d="M9.7 28.7c-.5-1.5-.8-3-.8-4.7s.3-3.2.8-4.7l-7-5.4C1 16.9 0 20.4 0 24s1 7.1 2.7 10.1l7-5.4z"
                                    />
                                    <path
                                        fill="#34A853"
                                        d="M24 48c6.5 0 11.9-2.1 15.9-5.8l-7.2-5.6c-2 1.4-4.6 2.3-8.7 2.3-6.7 0-12.4-3.8-15.3-9.2l-7 5.4C6.4 42.6 14.6 48 24 48z"
                                    />
                                </svg>

                                Google
                            </button>

                            <button
                                class="social-btn"
                                id="passkeyBtn"
                                type="button"
                            >
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path fill="#000" d="M3 20v-2.8q0-.85.438-1.562T4.6 14.55q1.55-.775 3.15-1.162T11 13q.5 0 1 .038t1 .112q-.1 1.45.525 2.738T15.35 18v2zm16 3l-1.5-1.5v-4.65q-1.1-.325-1.8-1.237T15 13.5q0-1.45 1.025-2.475T18.5 10t2.475 1.025T22 13.5q0 1.125-.638 2t-1.612 1.25L21 18l-1.5 1.5L21 21zm-8-11q-1.65 0-2.825-1.175T7 8t1.175-2.825T11 4t2.825 1.175T15 8t-1.175 2.825T11 12m7.5 2q.425 0 .713-.288T19.5 13t-.288-.712T18.5 12t-.712.288T17.5 13t.288.713t.712.287"/></svg>                                          Passkey
                            </button>
                        </div>

                        <div class="hr-text">
                            <span>OR CONTINUE WITH EMAIL</span>
                        </div>

                        <form>
                            <div class="input-block">
                                <label>Email Address</label>
                                <input
                                    type="email"
                                    placeholder="user@loadxpress.com.ng"
                                    name="email"
                                />
                                <span class="error" id="email-error"></span>
                            </div>

                            <div class="input-block" style="display: none;">
                                <label>Phone Number</label>
                                <div class="phone-input-group">
                                    <div class="ng-prefix">
                                        <img
                                            src="https://flagcdn.com/w20/ng.png"
                                            alt=""
                                        />
                                        <span>+234</span>
                                    </div>
                                    <input
                                        type="tel"
                                        placeholder="810 000 0000"
                                        name="phone"
                                    />
                                </div>
                                <span class="error" id="phone-error"></span>
                            </div>

                            <div class="input-block">
                                <label>Password</label>
                                <div class="pass-wrapper">
                                    <input
                                        type="password"
                                        placeholder="••••••••"
                                        name="password"
                                    />
                                    <span
                                        class="error"
                                        id="password-error"
                                    ></span>
                                </div>
                            </div>


                            <div
                                id="captchaWidget"
                                style="
                                  display: flex;
                                  justify-content: center;
                                  align-items: center;
                                  margin: 20px 0;
                                "
                              ></div>

                            <button class="main-submit" type="submit">
                                <span> Login Now </span>
                                <svg
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="3"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <path d="M5 12h14M12 5l7 7-7 7" />
                                </svg>
                            </button>
                        </form>
                        <p
                            class="error"
                            id="error"
                            style="
                                text-align: center;
                                margin-top: 15px;
                                font-size: 14px;
                            "
                        ></p>

                        <p class="switch-page">
                            Don't have an account?
                            <a href="/auth/signup">Register</a>
                        </p>
                    </div>
                </div>
            </div>

            <footer class="full-footer">
                <div class="footer-bottom">
                    <p>© 2026 LoadXpress Technologies. All rights reserved.</p>
                    <div class="footer-status">
                        <div class="status-dot"></div>
                        Systems Operational
                    </div>
                </div>
            </footer>
        </div>

        <script
            src="https://accounts.google.com/gsi/client"
            async
            defer
        ></script>
          <script src="https://hcaptcha.com/1/api.js" async defer></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="../assets/js/utils.js"></script>

        <script>
            const googleBtn = document.getElementById("googleBtn");
            const passkeyBtn = document.getElementById("passkeyBtn");
            const form = document.querySelector("form");
            passkeyBtn.addEventListener("click", async (e) => {
                e.preventDefault();

/*
                const publicKey = {
                  challenge: new Uint8Array(32),
                  rp: { name: "Demo Site" },
                  user: {
                    id: new Uint8Array([1,2,3,4]),
                    name: "demo@example.com",
                    displayName: "Demo User"
                  },
                  pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                  authenticatorSelection: {
                    residentKey: "required",      // <--- ensures username-less login
                    userVerification: "required"
                  },
                  timeout: 60000,
                  attestation: "none"
                };

                alert(await navigator.credentials.create({ publicKey }));

*/
                
                try {
                      const challenge = new Uint8Array(32);
                      window.crypto.getRandomValues(challenge);

                      // PublicKeyCredentialRequestOptions
                      const publicKey = {
                        challenge: challenge,
                        rpId: window.location.hostname, // your domain
                        allowCredentials: [], // empty = let browser show all passkeys
                        timeout: 60000,
                        userVerification: "required"
                      };

                      // This triggers the system passkey popup
                      const assertion = await navigator.credentials.get({ publicKey });
                      console.log("Passkey login popup done:", assertion);
                     // alert("Login popup completed! See console for details.");

                    alertIt("error", "Passkey login not success! Please sign-in with google or gmail");
                    
                    } catch (err) {
                    
                    //alertIt("error", "Error while signing in with passkey. Please try again later!");
                    
                    };

                
            });

            const alertIt = (icon, title) => {
                Swal.fire({
                    toast: true,
                    position: "top-end",
                    title,
                    icon,
                    timer: 5000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
            };


            const handleSignin = async (datas) => {
                try {
                    const response = await fetch("/auth/signin", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: datas.access_token
                            ? JSON.stringify({ c: datas.access_token })
                            : JSON.stringify({
                                  email: datas.email,
                                  password: datas.password,
                                token: window.__captchaToken
                              }),
                    });

                    if (!response.ok) {
                        throw new Error(
                            "Error while loginin your account. Please try again later!",
                        );
                    }

                    const data = await response.json();

                    if (data.success === false) {
                        throw new Error(data.error);
                    }
                    form.querySelector('button[type="submit"]').innerHTML =
                        `<span>Login Now</span> ${arrow}`;
                    form.reset();
                    if (!data.go_to) {
                        alertIt(
                            "success",
                            "Check your email for your login OTP! Redirecting...",
                        );
                        setTimeout(() => {
                       window.location.href = "/auth/verification?email=" + datas.email;   
                        }, 1000);
                    } else {
                        alertIt(
                            "success",
                            "Logged-In successfully! Redirecting to dashboard...",
                        );
                        setTimeout(() => {
                            window.location.href = data.go_to;
                        }, 1000);
                    }
                } catch (e) {
                    console.log(e);
                    alertIt("error", e.message);
                    form.querySelector('button[type="submit"]').innerHTML =
                        `<span>Login Now</span> ${arrow}`;
                    form.querySelector('button[type="submit"]').disabled =
                        false;
                    googleBtn.style.pointerEvents = "auto";
                    googleBtn.style.opacity = "1";
                }
            };
            googleBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!window.__googleClient) {
                    return alertIt(
                        "error",
                        "Google Sign-In has not been full loaded. Please try again later!",
                    );
                }
                window.__googleClient.requestAccessToken();
            });


            document.addEventListener("DOMContentLoaded", () => {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();

                    const emailError = document.getElementById("email-error");
                    const passwordError =
                        document.getElementById("password-error");
                    const formData = new FormData(form);
                    const email = formData.get("email").trim().toLowerCase();
                    const password = formData.get("password");

                    if (
                        !email ||
                        email === "" ||
                        !email.includes("@") ||
                        !email.includes(".")
                    ) {
                        emailError.textContent =
                            "Please enter a valid email address";
                        emailError.style.display = "block";
                        return;
                    }
                    emailError.style.display = "none";

                    const passwordErrorText = validatePassword(password);
                    if (passwordErrorText) {
                        passwordError.textContent = passwordErrorText;
                        passwordError.style.display = "block";
                        return;
                    }
                    passwordError.style.display = "none";

                    if (!window.__captchaToken){
                        alertIt("error", "Please complete the captcha!");
                        return;
                    }
                    form.querySelector('button[type="submit"]').innerHTML =
                        `<span>Login Now</span> ${rolling}`;
                    form.querySelector('button[type="submit"]').disabled = true;

                    handleSignin({
                        email,
                        password,
                    });
                });
            });

            window.onload = () => {
                try {
                    window.__googleClient =
                        google.accounts.oauth2.initTokenClient({
                            client_id:
                                "345121114864-2eto2f9elr7r3gcm8jva11m55a1q4rps.apps.googleusercontent.com",
                            scope: "email profile",
                            ux_mode: "popup",
                            callback: handleSignin
                        });
                } catch (e) {
                    alertIt(
                        "error",
                        "Error while initializing Google Sign-In. Please refresh the page!",
                    );
                };

                CAPTCHA_WID = hcaptcha.render("captchaWidget", {
                  sitekey: "994c2296-e6a8-4d28-9b52-df1cb73e48a6",
                  callback: (t) => {window.__captchaToken = t}
                });

            };
        </script>
    </body>
</html>